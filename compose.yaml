services:
  uptime-kuma:
    build:
      context: .
      dockerfile: docker/dockerfile 
    container_name: kuma
    environment:
      - NODE_ENV=production
      - UPTIME_KUMA_HOST=0.0.0.0
      # Add Node.js memory settings
      - NODE_OPTIONS=--max-old-space-size=768
      # Add performance settings
      - UPTIME_KUMA_DISABLE_SEND_METRICS=true
      - UPTIME_KUMA_DISABLE_REMOTE_BROWSER=true
    volumes:
      - ./data:/app/data
    ports:
      # <Host Port>:<Container Port>
      - 3003:3003
    restart: unless-stopped
    networks:
      - nginx
    # Add resource limits
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
        reservations:
          memory: 768M
          cpus: '0.5'
    # Add healthcheck to monitor the application
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3003/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # tcp-monitor:
  #   build: 
  #     context: ./tcpresponder
  #     dockerfile: Dockerfile
  #   ports:
  #     - "50000:50000"  # TCP monitor port
  #     - "8008:8008"    # API port
  #   volumes:
  #     - ./tcpresponder/data:/app/data
  #   restart: unless-stopped
  #   environment:
  #     - NINJA_CLIENT_ID=${NINJA_CLIENT_ID}
  #     - NINJA_CLIENT_SECRET=${NINJA_CLIENT_SECRET}
  #     - NINJA_TOKEN_URL=${NINJA_TOKEN_URL}
  #     - NINJA_SCOPE=${NINJA_SCOPE}
  #     - NINJA_API_BASE_URL=${NINJA_API_BASE_URL}
  #   networks:
  #     - nginx
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8008/ip"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 10s
  mariadb:
    image: mariadb:latest
    container_name: kuma-mariadb
    environment:
      - MYSQL_ROOT_PASSWORD=${UPTIME_KUMA_DB_PASSWORD}
      - MYSQL_DATABASE=${UPTIME_KUMA_DB_NAME}
      - MYSQL_USER=${UPTIME_KUMA_DB_USERNAME}
      - MYSQL_PASSWORD=${UPTIME_KUMA_DB_PASSWORD}
      # Improved database performance settings
      - MYSQL_INNODB_BUFFER_POOL_SIZE=512M
      - MYSQL_INNODB_LOG_FILE_SIZE=128M
      - MYSQL_MAX_CONNECTIONS=200
      - MYSQL_INNODB_FLUSH_METHOD=O_DIRECT
      - MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT=2
      - MYSQL_QUERY_CACHE_TYPE=1
      - MYSQL_QUERY_CACHE_SIZE=32M
    volumes:
      - ./data/mariadb:/var/lib/mysql
    ports:
      - "3306:3306"
    restart: unless-stopped
    networks:
      - nginx
    # Add resource limits
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
        reservations:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${UPTIME_KUMA_DB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  nginx:
    external: true